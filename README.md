
![alt text](https://repository-images.githubusercontent.com/166414581/dc0a1b80-a1a0-11e9-805b-cf8be46b5507)
# NFW a node Typescript boilerplate

![Build](https://github.com/TRIPTYK/nfw/workflows/Build/badge.svg?branch=develop)
![Test](https://github.com/TRIPTYK/nfw/workflows/Test/badge.svg?branch=develop)
![Lint](https://github.com/TRIPTYK/nfw/workflows/Lint/badge.svg?branch=develop)

This repository contains a REST API boilerplate [Express.js](http://expressjs.com/en/4x/api.html), [Typescript](https://github.com/Microsoft/TypeScript) and [TypeORM](https://github.com/typeorm/typeorm) based.

As a starter project, he implements some classic features :

* ORM layer
* User's management
* Document's management
* Authentification
* Routes validation
* File upload
* Logger
* Error handling
* Json-Api 1.0 compliant
* Unit testing

## Start with

Setup the boilerplate on your machine :

```bash
$ sh -c "$(curl -fsSL https://raw.githubusercontent.com/TRIPTYK/nfw/master/setup.sh)"
```
Kickstart project (create *dist* directory and sub-directories, install packages) :

```shell
$ npm run setup
```

Adapt your .env files (dev, test, staging, production) with your own configuration :

```env
# General informations
PORT = 8001
URL = http://localhost:8001
NODE_ENV = example
API_VERSION = v1

# Activate caching of requests , still experimental
REQUEST_CACHING = false

# CORS authorized domains
AUTHORIZED = http://localhost:8001,http://localhost:4200

# JWT informations
JWT_SECRET = h8566MNQ18oo5cMmHROVh8566MNQ18oo5cMmHROVh8566MNQ18oo5cMmHROVh8566MNQ18oo5cMmHROV
JWT_ACCESS_EXPIRATION_MINUTES = 5
JWT_REFRESH_EXPIRATION_MINUTES = 1440

# HTTPS
HTTPS_IS_ACTIVE = false
HTTPS_CERT = my-api.cert
HTTPS_KEY = my-api.key

# TypeORM
TYPEORM_TYPE = mysql
TYPEORM_NAME = default
TYPEORM_HOST = localhost
TYPEORM_DB = nfw
TYPEORM_USER = root
TYPEORM_PWD = test123*
TYPEORM_PORT = 3306

# Jimp image manipulation for picture documents
JIMP_IS_ACTIVE = true
JIMP_SIZE_XS = 320
JIMP_SIZE_MD = 768
JIMP_SIZE_XL = 1920

# Mail APIs credentials
MAIL_API_ID = ""
MAIL_API_ROUTE = ""

# Mailgun API credentials
MAILGUN_API_KEY = ""
MAILGUN_PUBLIC_KEY = ""
MAILGUN_DOMAIN = ""
MAILGUN_HOST = "api.mailgun.net"

# Elastic search engine
ELASTIC_ENABLE = false
ELASTIC_URL = http://localhost:9200

# Facebook oauth credentials
FACEBOOK_KEY='-1'
FACEBOOK_SECRET='-1'
FACEBOOK_REDIRECT_URL='-1'

# Google oauth credentials
GOOGLE_KEY='-1'
GOOGLE_SECRET='-1'
GOOGLE_REDIRECT_URL='-1'

# Outlook oauth credentials
OUTLOOK_KEY='-1'
OUTLOOK_SECRET='-1'
OUTLOOK_REDIRECT_URL='-1'
```

Run dev (ts-node) :

```bash
$ npm run start-dev
```

Run production :

```bash
$ npm run start
```

## Typescript Compilation

The production project is generated by default in the *dist* directory, after Typescript compilation.

Run one time compilation :

```bash
$ tsc
```

Run watching compilation :

```bash
$ tsc --watch
```

If required, yo can adapt typescript configuration in [tsconfig.json](https://www.typescriptlang.org/docs/handbook/tsconfig-json.html)

### Database migration

A TypeORM migration is a DB synchronizing. If your schema have pending changes, migration tool allow you to synchronize it.

More info about [typeorm migration](http://typeorm.io/#/migrations).

## Json-Api

This API is [JSON-API 1.0 compliant](https://jsonapi.org/format/)

### Fields

Global syntax : `fields[<relationOrEntity>]=<field1>,<field2>`

:info: Fields are enabled by default on repository , you can change this behavior like this : 

```js
  // example from UserController list method
  const [users, totalUsers] = await this.repository.jsonApiRequest(req.query, userRelations, {
    allowFields : false
  }).getManyAndCount();
```

### Sorting

Global syntax : `sort=-<fieldName1>,<fieldName2>`

"-" means DESC sortings , else ASC 

:info: Sorting is enabled by default on repository , you can change this behavior like this : 

```js
  // example from UserController list method
  const [users, totalUsers] = await this.repository.jsonApiRequest(req.query, userRelations, {
    allowSorting : false
  }).getManyAndCount();
```

### Includes

Global syntax : `include=<relation1>,<relation2>,....`

:info: Includes are enabled by default on repository , you can change this behavior like this : 

```js
  // example from UserController list method
  const [users, totalUsers] = await this.repository.jsonApiRequest(req.query, userRelations, {
    allowIncludes : false
  }).getManyAndCount();
```

### Pagination

Global syntax : `page[number]=<number>&page[size]=<number>`

:info: Pagination is enabled by default on repository , you can change this behavior like this : 

```js
  // example from UserController list method
  const [users, totalUsers] = await this.repository.jsonApiRequest(req.query, userRelations, {
    allowPagination : false
  }).getManyAndCount();
```

### Filters

Global syntax : `filter[<fieldName>]=<filter>:<value>`

:info: Filters are disabled by default on repository , it needs to be enabled manually by the developper like this : 

```js
  // example from UserController list method
  const [users, totalUsers] = await this.repository.jsonApiRequest(req.query, userRelations, {
    allowFilters : true
  }).getManyAndCount();
```

You can add a "or" keyword in front of the \<filter> if there's multiple filters on your request. By default a SQL AND is applied between filters

#### like

Apply SQL `<fieldName> LIKE <value>`
- Syntax : `filter[<fieldName>]=like:<likeExpression>`

#### eq

Apply SQL `<fieldName>=<value>`
- Syntax : `filter[<fieldName>]=eq:<value>`

#### noteq

Apply SQL `NOT <fieldName>=<value>`
- Syntax : `filter[<fieldName>]=noteq:<value>`

#### in

Apply SQL `<fieldName> IN (<value1>+<value2>+<...>)`
- Syntax : `filter[<fieldName>]=in:<value1>+<value2>+<...>`

#### notin

Apply SQL `<fieldName> NOT IN (<value1>+<value2>+<...>)`
- Syntax : `filter[<fieldName>]=notin:<value1>+<value2>+<...>`

#### suporeq

Apply SQL `<fieldName> >= <value>`
- Syntax : `filter[<fieldName>]=suporeq:<value>`

#### lessoreq

Apply SQL `<fieldName> <= <value>`
- Syntax : `filter[<fieldName>]=lessoreq:<value>`

#### btw

Apply SQL `<fieldName> BETWEEN <value1> AND <value2>`
- Syntax : `filter[<fieldName>]=btw:<value1>+<value2>`

## Testing

Some basic tests are already writted with [Mocha](https://mochajs.org/) and [Chai](https://www.chaijs.com/). They are located in *test* directory.

Run tests :

```bash
$ npm run test
```

## Deployment with PM2

Project implements a basic [PM2](https://github.com/Unitech/PM2/) configuration to allow easy deployment.

First, install PM2 globaly :

```bash
$ npm i pm2 -g
```

Note that PM2 should also be installed on other server environments, and that your SSH public key must be granted by the destination server.

### Setup

Configure the *ecosystem.config.js* file with your environments informations.

```javascript
deploy : {
    production : {
      user : 'nodejs',
      host : '<ip>',
      ssh_options : ["PasswordAuthentication=no","IdentityFile=<SSH_KEY>"],
      ref  : 'origin/develop',
      repo : 'git@github:TRIPTYK/nfw.git',
      path : '/var/www/nfw',
      'post-setup': 'npm run setup',
      'post-deploy' : 'npm run deploy production'
    }
  }
```
More info about PM2 [ecosystem.config.js](https://pm2.io/doc/en/runtime/reference/ecosystem-file/) file.

### Deploy

```bash
# Setup deployment at remote location
$ pm2 deploy production setup

# Update remote version
$ pm2 deploy production update

# Revert to -1 deployment
$ pm2 deploy production revert 1

# execute a command on remote servers
$ pm2 deploy production exec "pm2 reload all"
```

More info about [PM2 deploy](https://pm2.io/doc/en/runtime/guide/easy-deploy-with-ssh/).

More info about [PM2](http://pm2.keymetrics.io/docs/usage/quick-start/).
